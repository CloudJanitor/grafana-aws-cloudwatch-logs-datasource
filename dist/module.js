define(["lodash","react","@grafana/ui","app/core/table_model","app/core/utils/flatten","app/plugins/sdk"],function(e,t,r,n,a,o){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r(r.s=6)}([function(t,r){t.exports=e},function(e,r){e.exports=t},function(e,t){e.exports=r},function(e,t){e.exports=n},function(e,t){e.exports=a},function(e,t){e.exports=o},function(e,t,r){"use strict";r.r(t);
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function a(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function o(e,t,r,n){return new(r||(r=Promise))(function(a,o){function i(e){try{s(n.next(e))}catch(e){o(e)}}function u(e){try{s(n.throw(e))}catch(e){o(e)}}function s(e){e.done?a(e.value):new r(function(t){t(e.value)}).then(i,u)}s((n=n.apply(e,t||[])).next())})}function i(e,t){var r,n,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(o){return function(u){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(a=2&o[0]?n.return:o[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,o[1])).done)return a;switch(n=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,n=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=(a=i.trys).length>0&&a[a.length-1])&&(6===o[0]||2===o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],n=0}finally{r=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}}function u(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}var s=r(0),l=r.n(s),c=r(3),p=r.n(c),f=r(4),m=r.n(f),d=r(2),g=function(e){function t(t,r,n,a){var o=e.call(this,t)||this;o.backendSrv=r,o.templateSrv=n,o.timeSrv=a,o.type=t.type,o.url=t.url,o.name=t.name,o.id=t.id;var i=t.jsonData||{};return o.defaultRegion=i.defaultRegion,o}return t.$inject=["instanceSettings","backendSrv","templateSrv","timeSrv"],a(t,e),t.prototype.query=function(e){return o(this,void 0,void 0,function(){var t;return i(this,function(r){switch(r.label){case 0:return(t=this.buildQueryParameters(e)).targets=t.targets.filter(function(e){return!e.hide}),t.targets.length<=0?[2,Promise.resolve({data:[]})]:[4,this.doRequest({data:t})];case 1:return[2,r.sent()]}})})},t.prototype.testDatasource=function(){return this.doMetricQueryRequest("log_group_names",{region:this.defaultRegion,logGroupNamePrefix:"test"}).then(function(e){return Promise.resolve({status:"success",message:"Data source is working",title:"Success"})}).catch(function(e){return{status:"error",message:e.message,title:"Error"}})},t.prototype.doRequest=function(e){return o(this,void 0,void 0,function(){var t,r,n,a,s,c,p,f,m,d=this;return i(this,function(g){switch(g.label){case 0:return[4,Promise.all(e.data.targets.map(function(t){return o(d,void 0,void 0,function(){var r,n,a,o,u;return i(this,function(i){switch(i.label){case 0:return t.useInsights?[3,2]:[4,this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.data.range.from.valueOf().toString(),to:e.data.range.to.valueOf().toString(),queries:[t]}})];case 1:return[2,i.sent()];case 2:return[4,this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.data.range.from.valueOf().toString(),to:e.data.range.to.valueOf().toString(),queries:[t]}})];case 3:r=i.sent(),n=r.data.results[t.refId].meta.QueryId,t.queryId=n,a=void 0,o=0,i.label=4;case 4:return o<60?[4,this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.data.range.from.valueOf().toString(),to:e.data.range.to.valueOf().toString(),queries:[t]}})]:[3,10];case 5:return a=i.sent(),"Complete"!==(u=a.data.results[t.refId].meta.Status)?[3,6]:[3,10];case 6:if(!l.a.includes(["Failed","Cancelled"],u))return[3,7];throw new Error("insights query failed");case 7:return[4,this.delay(1e3)];case 8:return i.sent(),[3,9];case 9:return o++,[3,4];case 10:return[2,a]}})})}))];case 1:t=g.sent(),r={},l.a.each(t,function(e){l.a.each(e.data.results,function(e){r[e.refId]=e})}),n=[];try{for(a=u(e.data.targets),s=a.next();!s.done;s=a.next())c=s.value,p=r[c.refId],l.a.isEmpty(p.series)||l.a.forEach(p.series,function(e){n.push({target:e.name,datapoints:e.points})}),l.a.isEmpty(p.tables)||l.a.forEach(p.tables,function(e){n.push(d.expandMessageField(e))})}catch(e){f={error:e}}finally{try{s&&!s.done&&(m=a.return)&&m.call(a)}finally{if(f)throw f.error}}return[2,{data:n}]}})})},t.prototype.delay=function(e){return new Promise(function(t){return setTimeout(t,e)})},t.prototype.buildQueryParameters=function(e){var t=this,r=l.a.map(e.targets,function(r){var n={},a={};if(l.a.isNumber(r.limit)&&(r.limit=String(r.limit)),r.useInsights){var o=t.templateSrv.replace(r.logGroupName,e.scopedVars);a={queryString:t.templateSrv.replace(r.queryString,e.scopedVars),limit:parseInt(t.templateSrv.replace(r.limit,e.scopedVars),10)},o.indexOf(",")>=0?a.logGroupNames=o.split(","):a.logGroupName=o}else 0===(n={logGroupName:t.templateSrv.replace(r.logGroupName,e.scopedVars),logStreamNames:l.a.flatten(r.logStreamNames.filter(function(e){return""!==e}).map(function(r){var n=t.templateSrv.replace(r,e.scopedVars,"json");return r!==n?JSON.parse(n):r})),filterPattern:t.templateSrv.replace(r.filterPattern,e.scopedVars),limit:parseInt(t.templateSrv.replace(r.limit,e.scopedVars),10),interleaved:!1}).logStreamNames.length&&delete n.logStreamNames;return{refId:r.refId,hide:r.hide,datasourceId:t.id,queryType:"timeSeriesQuery",format:r.format||"timeserie",region:t.templateSrv.replace(r.region,e.scopedVars)||t.defaultRegion,useInsights:r.useInsights,legendFormat:r.legendFormat,timestampColumn:r.timestampColumn,valueColumn:r.valueColumn,startFromHead:!!l.a.isUndefined(r.startFromHead)||r.startFromHead,input:n,inputInsightsStartQuery:a}});return e.targets=r,e},t.prototype.expandMessageField=function(e){var t,r,n=new p.a,a={};if(0===e.rows.length)return n;n.columns=e.columns;var o=n.columns.findIndex(function(e){return"Message"===e.text}),i=e.rows.map(function(e){var t={};try{"{"===e[o][0]&&(t=JSON.parse(e[o]))}catch(e){}return t});l.a.each(i.slice(0,100),function(e){var t=m()(e,null);for(var r in t)a[r]=1});var u=l.a.keys(a).sort();for(l.a.each(u,function(e,t){a[e]=t+1,n.columns.push({text:e})}),t=0;t<e.rows.length;t++){var s=e.rows[t],c=i[t];for(r=0;r<u.length;r++){var f=u[r];s.push(l.a.get(c,f)||"")}n.rows.push(s)}return n},t.prototype.metricFindQuery=function(e){var t,r=e.match(/^log_group_names\(([^,]+?),\s?(.+)\)/);if(r){t=r[1];var n=r[2];return this.doMetricQueryRequest("log_group_names",{region:this.templateSrv.replace(t),logGroupNamePrefix:this.templateSrv.replace(n)})}var a=e.match(/^log_stream_names\(([^,]+?),\s?(.+)\)/);if(a){t=a[1];var o=a[2];return this.doMetricQueryRequest("log_stream_names",{region:this.templateSrv.replace(t),logGroupName:this.templateSrv.replace(o),logStreamNamePrefix:""})}return Promise.resolve([])},t.prototype.doMetricQueryRequest=function(e,t){var r=this,n=this.timeSrv.timeRange();return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:n.from.valueOf().toString(),to:n.to.valueOf().toString(),queries:[l.a.extend({refId:"metricFindQuery",datasourceId:this.id,queryType:"metricFindQuery",subtype:e},t)]}}).then(function(e){return r.transformSuggestDataFromTable(e.data)})},t.prototype.transformSuggestDataFromTable=function(e){return l.a.map(e.results.metricFindQuery.tables[0].rows,function(e){return{text:e[0],value:e[1]}})},t.prototype.annotationQuery=function(e){var t=this,r=e.annotation,n=r.region||this.defaultRegion,a=r.logGroupName||"",o=r.filterPattern||"",i=r.tagKeys||"";i=i.split(",");var u=r.titleFormat||"",s=r.textFormat||"";if(l.a.isEmpty(n)||l.a.isEmpty(a))return Promise.resolve([]);var c=this.timeSrv.timeRange();return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:c.from.valueOf().toString(),to:c.to.valueOf().toString(),queries:[{refId:"annotationQuery",datasourceId:this.id,queryType:"annotationQuery",region:this.templateSrv.replace(n),input:{logGroupName:this.templateSrv.replace(a),filterPattern:this.templateSrv.replace(o),interleaved:!1}}]}}).then(function(e){return e.data.results[""].meta.Events?e.data.results[""].meta.Events.map(function(e){var n=JSON.parse(e.Message),a=l.a.chain(n).filter(function(e,t){return l.a.includes(i,t)}).value();return{annotation:r,time:e.Timestamp,title:t.renderTemplate(u,n),tags:a,text:t.renderTemplate(s,n)}}):[]})},t.prototype.renderTemplate=function(e,t){return e.replace(/\{\{\s*(.+?)\s*\}\}/g,function(e,r){return t[r]?t[r]:r})},t}(d.DataSourceApi),h=function(e){function t(t,r,n){var a=e.call(this,t,r)||this;return a.scope=t,a.target.format=a.target.format||"table",a.target.region=a.target.region||"",a.target.logGroupName=a.target.logGroupName||"",a.target.logStreamNames=a.target.logStreamNames||[],a.target.filterPattern=a.target.filterPattern||"",a.target.queryString=a.target.queryString||"",a.target.startFromHead=!!l.a.isUndefined(a.target.startFromHead)||a.target.startFromHead,l.a.isNumber(a.target.limit)&&(a.target.limit=String(a.target.limit)),a.target.limit=a.target.limit||"10000",a.target.legendFormat=a.target.legendFormat||"",a.target.timestampColumn=a.target.timestampColumn||"",a.target.valueColumn=a.target.valueColumn||"",a.templateSrv=n,a.suggestLogGroupName=function(e,t){var r=a.target.region||a.datasource.defaultRegion;return a.datasource.doMetricQueryRequest("log_group_names",{region:a.templateSrv.replace(r),logGroupNamePrefix:e}).then(function(e){t(e.map(function(e){return e.value}))})},a.suggestLogStreamName=function(e,t){if(!a.target.logGroupName)return t([]);var r=a.target.region||a.datasource.defaultRegion;return a.datasource.doMetricQueryRequest("log_stream_names",{region:a.templateSrv.replace(r),logGroupName:a.target.logGroupName,logStreamNamePrefix:e}).then(function(e){t(e.map(function(e){return e.value}))})},a}return t.$inject=["$scope","$injector","templateSrv"],a(t,e),t.prototype.onChangeInternal=function(){this.panelCtrl.refresh()},t.templateUrl="partials/query.editor.html",t}(r(5).QueryCtrl),v=function(){function e(e,t){this.scope=e}return e.templateUrl="partials/annotations.editor.html",e}(),y=function(){function e(e,t){this.current.jsonData.authType=this.current.jsonData.authType||"credentials",this.accessKeyExist=this.current.secureJsonFields.accessKey,this.secretKeyExist=this.current.secureJsonFields.secretKey,this.datasourceSrv=t,this.authTypes=[{name:"Access & secret key",value:"keys"},{name:"Credentials file",value:"credentials"},{name:"ARN",value:"arn"}]}return e.$inject=["$scope","datasourceSrv"],e.prototype.resetAccessKey=function(){this.accessKeyExist=!1},e.prototype.resetSecretKey=function(){this.secretKeyExist=!1},e.templateUrl="partials/config.html",e}(),S=r(1),b=r.n(S),x=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state={field:""},t}return a(t,e),t.prototype.componentDidMount=function(){return o(this,void 0,void 0,function(){return i(this,function(e){return this.setState({}),[2]})})},t.prototype.componentDidUpdate=function(e){},t.prototype.render=function(){return b.a.createElement("div",{className:"gf-form-inline gf-form-inline--nowrap"},b.a.createElement("div",{className:"gf-form flex-shrink-0"}),b.a.createElement("div",{className:"flex-shrink-1 flex-flow-column-nowrap"}))},t}(b.a.PureComponent),N=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a(t,e),t.prototype.render=function(){return b.a.createElement("div",{className:"grafana-info-box grafana-info-box--max-lg"})},t}(S.PureComponent);r.d(t,"plugin",function(){return P});var P=new d.DataSourcePlugin(g).setConfigCtrl(y).setQueryCtrl(h).setAnnotationQueryCtrl(v).setExploreLogsQueryField(x).setExploreStartPage(N)}])});